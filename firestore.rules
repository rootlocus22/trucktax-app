rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users can read/write their own user document (including creation)
    // Agents can read all users (needed for agent queue)
    match /users/{userId} {
      // Allow read for authenticated users (agents need this for queue)
      allow read: if request.auth != null;
      // Allow write only for own user document
      allow write: if request.auth != null && request.auth.uid == userId;
      // Allow creation of own user document
      allow create: if request.auth != null && request.auth.uid == userId;
    }
    
    // Users can read/write their own businesses
    // Agents can read all businesses (needed for agent queue)
    match /businesses/{businessId} {
      // Allow read for authenticated users (agents need this for queue)
      allow read: if request.auth != null;
      // Allow write for own businesses only
      allow write: if request.auth != null && 
        (resource == null || resource.data.userId == request.auth.uid);
      // Allow creation if userId matches
      allow create: if request.auth != null && 
        request.resource.data.userId == request.auth.uid;
    }
    
    // Users can read/write their own vehicles
    // Agents can read all vehicles (needed for agent queue)
    match /vehicles/{vehicleId} {
      // Allow read for authenticated users (agents need this for queue)
      allow read: if request.auth != null;
      // Allow write for own vehicles only
      allow write: if request.auth != null && 
        (resource == null || resource.data.userId == request.auth.uid);
      // Allow creation if userId matches
      allow create: if request.auth != null && 
        request.resource.data.userId == request.auth.uid;
    }
    
    // Filings collection
    // Note: For queries to work, we need to allow read on documents that match the query
    // The agent portal is protected by ProtectedRoute component which checks user role
    // This allows authenticated users to query filings (needed for agent queue)
    match /filings/{filingId} {
      // Allow read for authenticated users (queries need this)
      // Security is enforced by ProtectedRoute component on client side
      allow read: if request.auth != null;
      
      // Allow write for authenticated users
      // Note: In production, consider using server-side API endpoints to verify agent role
      // For now, security is enforced by ProtectedRoute component on client side
      allow write: if request.auth != null;
      
      // Allow creation if userId matches
      allow create: if request.auth != null && 
        request.resource.data.userId == request.auth.uid;
    }
    
    // Draft Filings collection - users can only access their own drafts
    match /draftFilings/{draftId} {
      // Allow read for queries (where clause filters by userId) and own documents
      allow read: if request.auth != null && 
        (resource == null || resource.data.userId == request.auth.uid);
      
      // Allow write only for own drafts
      allow write: if request.auth != null && 
        (resource == null || resource.data.userId == request.auth.uid);
      
      // Allow creation if userId matches
      allow create: if request.auth != null && 
        request.resource.data.userId == request.auth.uid;
    }

    // Payments - users can only read their own (created by API on successful Stripe payment)
    match /payments/{paymentId} {
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      allow write: if false;
    }

    // FMCSA Cache - Allow server-side caching
    match /fmcsa_cache/{docId} {
      allow read, write: if request.auth != null;
    }
  }
}

